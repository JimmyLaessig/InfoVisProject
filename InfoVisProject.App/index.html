<!DOCTYPE html>
<html>
<head>    
    <title>Google maps GpsSensor layer with D3 for live position update</title>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdKoISSvWapqmNvTYZI0bWAavX_B7bXeQ"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.3.3/d3.min.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mousetrap/1.4.6/mousetrap.js" charset="utf-8"></script>
    
    <script src="./data/mapStyles.js" charset="utf-8"></script>
    <script src="./data/stations.js" charset="utf-8"></script>
    <script src="./Marker.js" charset="utf-8"></script>
    <script src="./Manager.js" charset="utf-8"></script>
    <style type="text/css" src = "./style.css" charset ="utf-8"></style>
    <!--<style type="text/css" src ="./style.css" charset="utf-8"></style>-->
    <style type="text/css">
        html,
        body,
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            color: blue;
        }

        
        svg {
            margin: 0;
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.0);
        }

        .tooltip {
            position: absolute;
            line-height: .7;
            font-weight: bold;
            padding: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            font-weight: bold;
            font: 11.5px sans-serif;
            border-radius: 2px;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script type="text/javascript">

        var stationCount = stations.length;

        var minLat  = Infinity;
        var maxLat  =-Infinity;
        var minLong = Infinity;
        var maxLong =-Infinity;
        
        for (var i = 0; i < stations.length; i++)
        {
            var lat = parseFloat(stations[i]["Lat"]);
            var long = parseFloat(stations[i]["Long"]);

            minLat      = Math.min(lat, minLat);
            maxLat      = Math.max(lat, maxLat);
            minLong     = Math.min(long, minLong);
            maxLong     = Math.max(long, maxLong);
        }
        
        var lat     = (maxLat + minLat) / 2.0;
        var long    = (maxLong + minLong) / 2.0;

        var activeMarkers = markers;


        var map = new google.maps.Map(d3.select("#map").node(), {
            zoom: 10,

            center: new google.maps.LatLng(lat, long),

            disableDefaultUI: true,
            draggableCursor: 'default'
        });
        google.maps.event.addListener(map, 'zoom_changed', function ()
        {            
            activeMarkers = filterStations(map.getZoom());            
        });

        map.mapTypes.set('custom', new google.maps.StyledMapType(styleGrey));
        map.setMapTypeId('custom');

        activeMarkers.forEach(m => { 
            var marker = new google.maps.Marker({
                position: new google.maps.LatLng(m.getLatitude, m.getLongitude),
                map: map,
                title: m.name
            });
        }); 

        var tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        var overlay = new google.maps.OverlayView();      
        

        overlay.draw = function ()
        {
            console.log("draw");
            d3.select(overlay.getPanes().overlayMouseTarget).selectAll("*").remove();
            var layer = d3.select(overlay.getPanes().overlayMouseTarget).append("div")
                .attr("class", "stations");


            var projection  = overlay.getProjection();
            var padding     = 25;

            
            var marker      = layer.selectAll("svg")
                .data(d3.entries(activeMarkers))
                .enter()
                .append("svg:svg")
                .each(transform)
                .attr("class", "marker")
                    .on("mouseover", function (d) {
                        
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                        tooltip.html(d.value.getTooltip)
                            .style("left", (d3.event.pageX + 5) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                    })
                    .on("mouseout", function (d) {
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", 0);
                });       


            marker.append("svg:path")
                .attr("d", "M75.671,48.659l-50-25c-0.543-0.272-1.192-0.19-1.65,0.206c-0.458,0.395-0.634,1.026-0.446,1.602l7.851,24.043  l-7.856,25.042c-0.18,0.574,0.001,1.201,0.459,1.591c0.277,0.236,0.623,0.358,0.973,0.358c0.229,0,0.458-0.052,0.671-0.158l50-25  c0.508-0.254,0.829-0.773,0.829-1.342S76.179,48.913,75.671,48.659z")
                .attr("clip-rule", "evenodd")
                .attr("fill", "#0D0D0D")
                .attr("fill-rule", "evenodd")
                .attr("transform", (d) => "scale(0.6) translate (-15 -16) rotate(" + d.value.getRotation.toString() + " 50 50)");


            marker.append("svg:path")
                .attr("d", "M75.671,48.659l-50-25c-0.543-0.272-1.192-0.19-1.65,0.206c-0.458,0.395-0.634,1.026-0.446,1.602l7.851,24.043  l-7.856,25.042c-0.18,0.574,0.001,1.201,0.459,1.591c0.277,0.236,0.623,0.358,0.973,0.358c0.229,0,0.458-0.052,0.671-0.158l50-25  c0.508-0.254,0.829-0.773,0.829-1.342S76.179,48.913,75.671,48.659z")
                .attr("clip-rule", "evenodd")
                .attr("fill", (d) => d.value.getColor)
                .attr("fill-rule", "evenodd")
                .attr("transform", (d) => "scale(0.5) translate(-8 -10) rotate(" + d.value.getRotation.toString() + " 50 50)");
            

            function transform(d) {
                d = new google.maps.LatLng(d.value.getLatitude, d.value.getLongitude);
                d = projection.fromLatLngToDivPixel(d);
                return d3.select(this)
                    .style("left", (d.x)  - 25.0 + "px")
                    .style("top", (d.y) - 25.0 + "px");
            }
        };

       
        Mousetrap.bind('+', function (e, n) { markers = markers.map((marker) => new Marker(marker.id, marker.name, marker.lat, marker.long, marker.year1, marker.value1, marker.year2, marker.value2 + 0.1)); overlay.draw(); });
        Mousetrap.bind('-', function (e, n) { markers = markers.map((marker) => new Marker(marker.id, marker.name, marker.lat, marker.long, marker.year1, marker.value1, marker.year2, marker.value2 - 0.1)); overlay.draw(); });

        // Bind our overlay to the map…
        overlay.setMap(map);
    </script>
</body>
</html>