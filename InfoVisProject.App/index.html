<!DOCTYPE html>
<html>
<head>    
    <title>Google maps GpsSensor layer with D3 for live position update</title>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdKoISSvWapqmNvTYZI0bWAavX_B7bXeQ"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.3.3/d3.min.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mousetrap/1.4.6/mousetrap.js" charset="utf-8"></script>
    
    <script src="./data/mapStyles.js" charset="utf-8"></script>
    <script src="./data/stations.js" charset="utf-8"></script>


    <style type="text/css">
        html,
        body,
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            color: blue;
        }

        .stations,
        .stations svg {
            margin: auto;
            position: absolute;
            width: 100px;
            height: 100px;
            background: rgba(0, 0, 0, 0.8);
        }
 


            .tooltip {
                position: absolute;
                line-height: .7;
                font-weight: bold;
                padding: 8px;
                background: rgba(0, 0, 0, 0.8);
                color: #fff;
                font-weight: bold;
                font: 11.5px sans-serif;
                border-radius: 2px;
                pointer-events: none;
            }
    </style>
</head>
<body>

    <div id="map"></div>

    <script type="text/javascript">

        var stationCount = stations.length;
        
        var lat = 0;
        var long = 0;

        

        for (var i = 0; i < stations.length; i++) {
            var station = stations[i];
            lat += parseFloat(station["Lat"]);
            long += parseFloat(station["Long"]);
        }

        lat /= stations.length;
        long /= stations.length;

        var map = new google.maps.Map(d3.select("#map").node(), {
            zoom: 12,

            center: new google.maps.LatLng(lat, long),

            disableDefaultUI: true,
            draggableCursor: 'default'
        });

        map.mapTypes.set('custom', new google.maps.StyledMapType(styleGrey));
        map.setMapTypeId('custom');

        var tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        var overlay = new google.maps.OverlayView();
       
        var rotation = 0.0;

        Mousetrap.bind('+', function (e, n) { rotation = rotation + 10; console.log(rotation); overlay.draw(); });
        Mousetrap.bind('-', function (e, n) { rotation = rotation - 10; console.log(rotation); overlay.draw(); });

        overlay.draw = function ()
        {
            d3.select(overlay.getPanes().overlayMouseTarget).selectAll("*").remove();
            var layer = d3.select(overlay.getPanes().overlayMouseTarget).append("div")
                .attr("class", "stations");


            var projection  = overlay.getProjection();
            var padding     = 20;

            
            var marker      = layer.selectAll("svg")
                .data(d3.entries(stations))
                .enter()
                .append("svg:svg")
                .each(transform)
                .attr("class", "marker")
                    .on("mouseover", function (d) {

                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                        tooltip.html(d.value["Name"])
                            .style("left", (d3.event.pageX + 5) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                    })
                    .on("mouseout", function (d) {
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", 0);
                });       

            marker.append("svg:path")
                .attr("d", "M75.671,48.659l-50-25c-0.543-0.272-1.192-0.19-1.65,0.206c-0.458,0.395-0.634,1.026-0.446,1.602l7.851,24.043  l-7.856,25.042c-0.18,0.574,0.001,1.201,0.459,1.591c0.277,0.236,0.623,0.358,0.973,0.358c0.229,0,0.458-0.052,0.671-0.158l50-25  c0.508-0.254,0.829-0.773,0.829-1.342S76.179,48.913,75.671,48.659z")
                .attr("clip-rule", "evenodd")
                .attr("fill", "#0D0D0D")
                .attr("fill-rule", "evenodd")
                .attr("transform", "rotate("+ rotation.toString() + " 50 50)");

            marker.append("svg:path")
                .attr("d", "M75.671,48.659l-50-25c-0.543-0.272-1.192-0.19-1.65,0.206c-0.458,0.395-0.634,1.026-0.446,1.602l7.851,24.043  l-7.856,25.042c-0.18,0.574,0.001,1.201,0.459,1.591c0.277,0.236,0.623,0.358,0.973,0.358c0.229,0,0.458-0.052,0.671-0.158l50-25  c0.508-0.254,0.829-0.773,0.829-1.342S76.179,48.913,75.671,48.659z")
                .attr("clip-rule", "evenodd")
                .attr("fill", "#FF0D0D")
                .attr("fill-rule", "evenodd")
                .attr("transform", "scale(0.7) translate(21 21) rotate(" + rotation.toString() + " 50 50)");

                //.attr("transform", "translate(0, 0)");
            //marker.append("svg:circle")
            //    .attr("r", 11)
            //    .attr("cx", 50)
            //    .attr("cy", 50);
            // Add a label.
            

            function transform(d) {
                //console.log("transform");
                var lat = parseFloat(d.value["Lat"]);
                var long = parseFloat(d.value["Long"]);
                d = new google.maps.LatLng(lat, long);
                d = projection.fromLatLngToDivPixel(d);
                return d3.select(this)
                    .style("left", (d.x) + "px")
                    .style("top", (d.y) + "px");
            }
        };

        // Bind our overlay to the map…
        overlay.setMap(map);
    </script>
</body>
</html>